/*--------------------------------------------------------------------------------------------------------------------*/

use mime;

use tauri::http;

use mime_guess::from_path;

use std::{fs, env, path::PathBuf};

/*--------------------------------------------------------------------------------------------------------------------*/

#[cfg_attr(mobile, tauri::mobile_entry_point)]
pub fn run()
{
    /*----------------------------------------------------------------------------------------------------------------*/

    let addons_dir = env::var("HOME").map(PathBuf::from)
                                     .map(|home_dir| home_dir.join(".local/nyx-dashboard/addons"))
                                     .expect("Error determining the addon directory")
    ;

    fs::create_dir_all(&addons_dir).expect("Error creating the addons directory");

    /*----------------------------------------------------------------------------------------------------------------*/

    tauri::Builder::default()

        /*------------------------------------------------------------------------------------------------------------*/
        /* ADDON PROTOCOL                                                                                             */
        /*------------------------------------------------------------------------------------------------------------*/

        .register_uri_scheme_protocol("addon", move |_, req| {

            /*--------------------------------------------------------------------------------------------------------*/
            /* GET FILE PATH                                                                                          */
            /*--------------------------------------------------------------------------------------------------------*/

            let uri = req.uri().to_string();

            let uri_without_query = uri.split('?').next().unwrap_or(&uri);

            let file_path = addons_dir.join(uri_without_query.replace("addon://", "").trim());

            /*--------------------------------------------------------------------------------------------------------*/
            /* GET FILE MIME                                                                                          */
            /*--------------------------------------------------------------------------------------------------------*/

            let file_mime = from_path(&file_path).first_or_octet_stream();

            /*--------------------------------------------------------------------------------------------------------*/
            /* SERVE FILE                                                                                             */
            /*--------------------------------------------------------------------------------------------------------*/

            match fs::read(file_path) {

                /*----------------------------------------------------------------------------------------------------*/

                Ok(content) => return http::Response::builder()
                    .status(http::StatusCode::OK)
                    .header(http::header::ACCESS_CONTROL_ALLOW_ORIGIN, "*")
                    .header(http::header::CONTENT_TYPE, file_mime.essence_str())
                    .body(content)
                    .unwrap(),

                /*----------------------------------------------------------------------------------------------------*/

                Err(e) => return http::Response::builder()
                    .status(http::StatusCode::NOT_FOUND)
                    .header(http::header::ACCESS_CONTROL_ALLOW_ORIGIN, "*")
                    .header(http::header::CONTENT_TYPE, mime::TEXT_PLAIN.essence_str())
                    .body(e.to_string().into_bytes())
                    .unwrap(),

                /*----------------------------------------------------------------------------------------------------*/
            };
        })

        /*------------------------------------------------------------------------------------------------------------*/
        /* REMOTE URLS                                                                                                */
        /*------------------------------------------------------------------------------------------------------------*/

        .manage(RemoteUrls {urls: Mutex::new(vec![])})

        /*------------------------------------------------------------------------------------------------------------*/
        /* PLUGINS                                                                                                    */
        /*------------------------------------------------------------------------------------------------------------*/

        .invoke_handler(tauri::generate_handler![add_remote_url])

        /*------------------------------------------------------------------------------------------------------------*/
        /* PLUGINS                                                                                                    */
        /*------------------------------------------------------------------------------------------------------------*/

        .plugin(tauri_plugin_notification::init())
        .plugin(tauri_plugin_dialog::init())
        .plugin(tauri_plugin_shell::init())
        .plugin(tauri_plugin_fs::init())

        /*------------------------------------------------------------------------------------------------------------*/
        /* APP                                                                                                        */
        /*------------------------------------------------------------------------------------------------------------*/

        .run(tauri::generate_context!()).expect("error while running tauri application")

        /*------------------------------------------------------------------------------------------------------------*/
    ;

    /*----------------------------------------------------------------------------------------------------------------*/
}

/*--------------------------------------------------------------------------------------------------------------------*/
