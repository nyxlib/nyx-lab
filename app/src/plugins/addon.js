// noinspection JSUnusedGlobalSymbols
/*--------------------------------------------------------------------------------------------------------------------*/

import {useIndiStore} from 'vue-indi';

import * as uuid from 'uuid';

/*--------------------------------------------------------------------------------------------------------------------*/

import router from '../router';

import useConfigStore from '../stores/config';

/*--------------------------------------------------------------------------------------------------------------------*/

const ADDON_REGEX = /window\s*\.\s*(addon_[a-zA-Z_][a-zA-Z0-9_]*)\s*=/;

/*--------------------------------------------------------------------------------------------------------------------*/

function _load(app, path)
{
    /*----------------------------------------------------------------------------------------------------------------*/

    return new Promise((resolve, reject) => {

        /*------------------------------------------------------------------------------------------------------------*/

        fetch(path).then((response) => {

            response.text().then((sourcecode) =>  {

                const m = sourcecode.match(ADDON_REGEX);

                if(m)
                {
                    /*------------------------------------------------------------------------------------------------*/

                    const addonName = m[1];

                    /*------------------------------------------------------------------------------------------------*/

                    if(typeof window[addonName] !== 'undefined')
                    {
                        resolve([window[addonName].default, addonName, false]);
                    }
                    else
                    {
                        /*--------------------------------------------------------------------------------------------*/

                        const script = document.createElement('script');

                        /*--------------------------------------------------------------------------------------------*/

                        script.addEventListener('load', () => {

                            const module = window[addonName].default;

                            if(typeof module.install === 'function')
                            {
                                app.use(module);
                            }

                            resolve([module, addonName, true]);
                        });

                        /*--------------------------------------------------------------------------------------------*/

                        script.addEventListener('error', () => {

                            reject(`Error loading addon ${path}`);
                        });

                        /*--------------------------------------------------------------------------------------------*/

                        script.type = 'text/javascript';

                        script.src = path;

                        script.async = true;

                        /*--------------------------------------------------------------------------------------------*/

                        document.head.appendChild(script);

                        /*--------------------------------------------------------------------------------------------*/
                    }

                    /*------------------------------------------------------------------------------------------------*/
                }
                else {

                    reject('not an addon');
                }

            }).catch((e) => {

                reject(e);
            });

        }).catch((e) => {

            reject(e);
        });
    });

    /*----------------------------------------------------------------------------------------------------------------*/
}

/*--------------------------------------------------------------------------------------------------------------------*/

const _updateVariables = (name1, name2, fractionDigits) => {

    /*----------------------------------------------------------------------------------------------------------------*/

    const indiStore = useIndiStore();
    const configStore = useConfigStore();

    /*----------------------------------------------------------------------------------------------------------------*/

    try
    {
        if(configStore.globals[name2])
        {
            const def = indiStore.resolve(configStore.globals[name2]);

            if(def !== null)
            {
                configStore.globals[name1] = Number(Number(def['$']).toFixed(fractionDigits));
            }
        }
    }
    catch(e)
    {
        /* IGNORE */
    }

    /*----------------------------------------------------------------------------------------------------------------*/
};

/*--------------------------------------------------------------------------------------------------------------------*/

export default {

    install(app)
    {
        app.provide('addon', {
            /**/
            load: (path) => _load(app, path),
            /**/
            app: () => app,
            router: () => router,
            indiStore: () => useIndiStore(),
            configStore: () => useConfigStore(),
            newId: () => uuid.v4().substring(0, 13),
            /**/
            updateVariables: _updateVariables,
        });
    }
};

/*--------------------------------------------------------------------------------------------------------------------*/
